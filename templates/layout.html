<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}PUMP - Music Player{% endblock %}</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
        <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/logo.png') }}">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/global-status.css') }}">
        {% block head %}{% endblock %}
    </head>
<body>
    <!-- Global analysis status indicator -->
    <div id="global-status-bar" class="global-status" style="display: none;"></div>
    
    {% block content %}{% endblock %}
    
    <!-- Now Playing bar -->
    <div id="now-playing-bar" class="now-playing-bar">
        <div class="now-playing-container">
            <div class="now-playing-art">
                <img id="now-playing-art" src="{{ url_for('static', filename='images/default-album-art.png') }}" alt="Album Art">
            </div>
            
            <div class="now-playing-info">
                <div id="now-playing-title" class="now-playing-title">Not Playing</div>
                <div id="now-playing-artist" class="now-playing-artist">Select a track to play</div>
            </div>
            
            <div class="player-controls">
                <button id="prev-track" class="control-button" title="Previous Track">‚èÆ</button>
                <button id="play-pause" class="control-button" title="Play/Pause">‚ñ∂</button>
                <button id="next-track" class="control-button" title="Next Track">‚è≠</button>
            </div>
            
            <div class="progress-container">
                <span id="current-time" class="time">0:00</span>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <span id="total-time" class="time">0:00</span>
            </div>
            
            <div class="volume-controls">
                <button id="mute-button" class="control-button" title="Mute">üîä</button>
                <div class="volume-slider-container">
                    <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.7">
                </div>
            </div>
        </div>
    </div>

    <!-- Audio element for playback -->
    <audio id="audio-player"></audio>
    
    <!-- Common scripts used across all pages -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/player-controls.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navigation.js') }}"></script>
    
    <script>
        // Global analysis status checking
        const globalStatusBar = document.getElementById('global-status-bar');
        let globalStatusInterval = null;
        
        function checkGlobalAnalysisStatus() {
            fetch('/api/analysis/status')
                .then(response => response.json())
                .then(data => {
                    if (data.running) {
                        // Show status bar
                        const filesProcessed = data.files_processed || 0;
                        const totalFiles = data.total_files || 0;
                        const percent = data.percent_complete || 0;
                        
                        let statusHtml = `
                            <div class="status-content">
                                <div class="status-spinner"></div>
                                <div class="status-text">
                                    <strong>Analyzing Music Library:</strong> 
                                    ${filesProcessed} of ${totalFiles} files (${percent}%)
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percent}%"></div>
                            </div>
                        `;
                        
                        globalStatusBar.innerHTML = statusHtml;
                        globalStatusBar.style.display = 'block';
                        globalStatusBar.classList.remove('status-error', 'status-success');
                        
                        // Ensure interval is running
                        if (!globalStatusInterval) {
                            globalStatusInterval = setInterval(checkGlobalAnalysisStatus, 2000);
                        }
                    } else if (data.error) {
                        // Show error
                        globalStatusBar.innerHTML = `
                            <div class="status-content">
                                <div class="status-error-icon">‚ö†Ô∏è</div>
                                <div class="status-text">
                                    <strong>Analysis Error:</strong> ${data.error}
                                </div>
                                <div class="status-close" onclick="dismissGlobalStatus()">√ó</div>
                            </div>
                        `;
                        globalStatusBar.style.display = 'block';
                        globalStatusBar.classList.add('status-error');
                        globalStatusBar.classList.remove('status-success');
                        
                        // Clear interval after showing error
                        clearInterval(globalStatusInterval);
                        globalStatusInterval = null;
                    } else if (data.last_updated && new Date(data.last_updated) > new Date(Date.now() - 5000) && data.files_processed > 0) {
                        // Analysis just completed within the last 5 seconds
                        globalStatusBar.innerHTML = `
                            <div class="status-content">
                                <div class="status-success-icon">‚úì</div>
                                <div class="status-text">
                                    <strong>Analysis Complete:</strong> 
                                    Processed ${data.files_processed} files, added ${data.tracks_added || 0} tracks
                                </div>
                                <div class="status-close" onclick="dismissGlobalStatus()">√ó</div>
                            </div>
                        `;
                        globalStatusBar.style.display = 'block';
                        globalStatusBar.classList.add('status-success');
                        globalStatusBar.classList.remove('status-error');
                        
                        // Auto-dismiss after 10 seconds
                        setTimeout(dismissGlobalStatus, 10000);
                        
                        // Clear interval
                        clearInterval(globalStatusInterval);
                        globalStatusInterval = null;
                    } else {
                        // No active analysis
                        globalStatusBar.style.display = 'none';
                        globalStatusBar.classList.remove('status-error', 'status-success');
                        
                        // Clear interval if there's nothing to check
                        clearInterval(globalStatusInterval);
                        globalStatusInterval = null;
                    }
                })
                .catch(error => {
                    console.error('Error checking global analysis status:', error);
                    
                    // Clear interval on error
                    clearInterval(globalStatusInterval);
                    globalStatusInterval = null;
                });
        }
        
        function dismissGlobalStatus() {
            if (globalStatusBar) {
                globalStatusBar.style.display = 'none';
                globalStatusBar.classList.remove('status-error', 'status-success');
            }
        }
        
        // Make functions available globally
        window.dismissGlobalStatus = dismissGlobalStatus;
        window.globalStatusBar = globalStatusBar;
        window.checkGlobalAnalysisStatus = checkGlobalAnalysisStatus;
        
        // Ensure this runs first before any page-specific scripts
        document.addEventListener('DOMContentLoaded', function() {
            // Initial check on page load - run immediately
            checkGlobalAnalysisStatus();
            
            // Also start polling right away if no interval exists
            if (!globalStatusInterval) {
                globalStatusInterval = setInterval(checkGlobalAnalysisStatus, 2000);
            }
        }, { once: true });  // Using 'once: true' to ensure it only runs once
    </script>
    
    {% if request.endpoint == 'settings' %}
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
    {% endif %}
    
    {% block scripts %}{% endblock %}
</body>
</html>
<!-- Add this somewhere in your sidebar, after the navigation links -->
<div id="global-status-container" class="sidebar-section" style="display: none;">
    <h3>Background Tasks</h3>
    <div id="metadata-task" class="task-status" style="display: none;">
        <div class="task-header">
            <span class="task-title">Metadata Update</span>
            <span class="task-info"></span>
        </div>
        <div class="task-progress-bar">
            <div class="task-progress-fill"></div>
        </div>
    </div>
</div>